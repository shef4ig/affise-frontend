<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affise Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script>
    // ====== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ======
    const API_URL = 'https://affise-backend-production.up.railway.app';
    
    // ====== –°–û–°–¢–û–Ø–ù–ò–ï ======
    let state = {
        token: localStorage.getItem('token'),
        username: localStorage.getItem('username'),
        isLoggedIn: !!localStorage.getItem('token'),
        currentPage: 'login',
        dateFrom: getYesterdayDate(),
        dateTo: getYesterdayDate(),
        dashboardData: null,
        loading: false,
        error: null
    };

    // ====== –£–¢–ò–õ–ò–¢–´ ======
    function getYesterdayDate() {
        const date = new Date();
        date.setDate(date.getDate() - 1);
        return date.toISOString().split('T')[0];
    }

    function getTodayDate() {
        return new Date().toISOString().split('T')[0];
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 0
        }).format(value);
    }

    function formatNumber(value) {
        return new Intl.NumberFormat('ru-RU').format(Math.round(value));
    }

    // ====== API –ó–ê–ü–†–û–°–´ ======
    async function login(username, password) {
        try {
            state.loading = true;
            state.error = null;

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);

            const response = await fetch(`${API_URL}/token`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
            }

            const data = await response.json();
            
            localStorage.setItem('token', data.access_token);
            localStorage.setItem('username', username);
            
            state.token = data.access_token;
            state.username = username;
            state.isLoggedIn = true;
            state.currentPage = 'dashboard';
            
            render();
        } catch (error) {
            state.error = error.message;
            render();
        } finally {
            state.loading = false;
        }
    }

    async function loadDashboardData(dateFrom, dateTo) {
        try {
            state.loading = true;
            state.error = null;

            const response = await fetch(
                `${API_URL}/api/dashboard-data?date_from=${dateFrom}&date_to=${dateTo}`,
                {
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json'
                    }
                }
            );

            if (response.status === 401) {
                throw new Error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ.');
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }

            const data = await response.json();
            state.dashboardData = data;
            state.dateFrom = dateFrom;
            state.dateTo = dateTo;
            
            render();
        } catch (error) {
            state.error = error.message;
            render();
        } finally {
            state.loading = false;
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        state.token = null;
        state.username = null;
        state.isLoggedIn = false;
        state.currentPage = 'login';
        state.dashboardData = null;
        render();
    }

    // ====== –ö–û–ú–ü–û–ù–ï–ù–¢–´ ======
    function LoginPage() {
        return `
            <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 to-blue-600">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
                        üìä Affise Analytics
                    </h1>
                    
                    ${state.error ? `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            ‚ùå ${state.error}
                        </div>
                    ` : ''}
                    
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">–õ–æ–≥–∏–Ω</label>
                            <input 
                                type="text" 
                                id="username" 
                                placeholder="admin"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500"
                                required
                            />
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">–ü–∞—Ä–æ–ª—å</label>
                            <input 
                                type="password" 
                                id="password" 
                                placeholder="admin123"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500"
                                required
                            />
                        </div>
                        
                        <button 
                            type="submit"
                            class="w-full bg-purple-600 text-white font-semibold py-2 rounded-lg hover:bg-purple-700 transition"
                            ${state.loading ? 'disabled' : ''}
                        >
                            ${state.loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–í–æ–π—Ç–∏'}
                        </button>
                    </form>
                </div>
            </div>
        `;
    }

    function DashboardPage() {
        if (!state.dashboardData) {
            return `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                </div>
            `;
        }

        const data = state.dashboardData;
        const conversions = data.conversions || [];
        
        // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
        const metrics = calculateMetrics(conversions);

        return `
            <div class="min-h-screen bg-gray-100">
                <!-- HEADER -->
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 shadow-lg">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold">üìä Affise Analytics Dashboard</h1>
                            <p class="text-purple-100 mt-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>${state.username}</strong></p>
                        </div>
                        <button 
                            onclick="handleLogout()"
                            class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-lg font-semibold transition"
                        >
                            –í—ã—Ö–æ–¥
                        </button>
                    </div>
                </div>

                <!-- MAIN CONTENT -->
                <div class="max-w-7xl mx-auto p-6">
                    <!-- –§–ò–õ–¨–¢–†–´ -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">–§–∏–ª—å—Ç—Ä—ã</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">–î–∞—Ç–∞ –æ—Ç</label>
                                <input 
                                    type="date" 
                                    id="dateFrom"
                                    value="${state.dateFrom}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">–î–∞—Ç–∞ –¥–æ</label>
                                <input 
                                    type="date" 
                                    id="dateTo"
                                    value="${state.dateTo}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                />
                            </div>
                            <div class="flex items-end">
                                <button 
                                    onclick="handleLoadData()"
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 rounded-lg transition"
                                    ${state.loading ? 'disabled' : ''}
                                >
                                    ${state.loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å'}
                                </button>
                            </div>
                        </div>
                    </div>

                    ${state.error ? `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                            ‚ùå ${state.error}
                        </div>
                    ` : ''}

                    <!-- –ú–ï–¢–†–ò–ö–ò -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-gray-600 text-sm font-semibold mb-2">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (–û–ü)</h3>
                            <p class="text-3xl font-bold text-green-600">${formatCurrency(metrics.totalEarnings)}</p>
                            <p class="text-xs text-gray-500 mt-2">–°—É–º–º–∞ earnings</p>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-gray-600 text-sm font-semibold mb-2">–û–±—â–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç (–û–†–ë)</h3>
                            <p class="text-3xl font-bold text-blue-600">${formatCurrency(metrics.totalRevenue)}</p>
                            <p class="text-xs text-gray-500 mt-2">–°—É–º–º–∞ revenue</p>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-gray-600 text-sm font-semibold mb-2">–ö–æ–Ω–≤–µ—Ä—Å–∏–∏</h3>
                            <p class="text-3xl font-bold text-orange-600">${formatNumber(metrics.conversions)}</p>
                            <p class="text-xs text-gray-500 mt-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π</p>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-gray-600 text-sm font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã</h3>
                            <p class="text-3xl font-bold text-indigo-600">${formatNumber(metrics.activeOffers)}</p>
                            <p class="text-xs text-gray-500 mt-2">Earnings >= 5000</p>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-gray-600 text-sm font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã</h3>
                            <p class="text-3xl font-bold text-pink-600">${formatNumber(metrics.activePartners)}</p>
                            <p class="text-xs text-gray-500 mt-2">Earnings >= 5000</p>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-gray-600 text-sm font-semibold mb-2">ROMI</h3>
                            <p class="text-3xl font-bold text-red-600">${metrics.romi.toFixed(2)}%</p>
                            <p class="text-xs text-gray-500 mt-2">(–î–æ—Ö–æ–¥ / –û–†–ë) * 100</p>
                        </div>
                    </div>

                    <!-- –¢–ê–ë–õ–ò–¶–ê –ö–û–ù–í–ï–†–°–ò–ô -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">–ö–æ–Ω–≤–µ—Ä—Å–∏–∏ (${conversions.length})</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 border-b">
                                    <tr>
                                        <th class="px-4 py-2 text-left">ID</th>
                                        <th class="px-4 py-2 text-left">–û—Ñ—Ñ–µ—Ä</th>
                                        <th class="px-4 py-2 text-left">–ü–∞—Ä—Ç–Ω–µ—Ä</th>
                                        <th class="px-4 py-2 text-left">–°—Ç–∞—Ç—É—Å</th>
                                        <th class="px-4 py-2 text-right">Revenue</th>
                                        <th class="px-4 py-2 text-right">Earnings</th>
                                        <th class="px-4 py-2 text-left">–î–∞—Ç–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${conversions.slice(0, 20).map(conv => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-2 text-xs text-gray-500">${conv.id}</td>
                                            <td class="px-4 py-2">${conv.offer_title || 'N/A'}</td>
                                            <td class="px-4 py-2">${conv.partner_id || 'N/A'}</td>
                                            <td class="px-4 py-2">
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    conv.status === 'confirmed' 
                                                    ? 'bg-green-100 text-green-800' 
                                                    : 'bg-yellow-100 text-yellow-800'
                                                }">
                                                    ${conv.status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-2 text-right">${formatCurrency(conv.revenue || 0)}</td>
                                            <td class="px-4 py-2 text-right font-semibold">${formatCurrency(conv.earnings || 0)}</td>
                                            <td class="px-4 py-2 text-xs text-gray-500">${new Date(conv.created_at).toLocaleDateString('ru-RU')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${conversions.length > 20 ? `
                            <p class="text-center text-gray-500 text-sm mt-4">–ü–æ–∫–∞–∑–∞–Ω–æ 20 –∏–∑ ${conversions.length} –∑–∞–ø–∏—Å–µ–π</p>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    function calculateMetrics(conversions) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ goal_value –≤ [1, 2, 5, 10] –∏ status = 'confirmed'
        const filtered = conversions.filter(c => 
            [1, 2, 5, 10].includes(c.goal_value) && c.status === 'confirmed'
        );

        // –û–ü (–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å) - —Å—É–º–º–∞ earnings
        const totalEarnings = filtered.reduce((sum, c) => sum + (c.earnings || 0), 0);

        // –û–†–ë (–û–±—â–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç) - —Å—É–º–º–∞ revenue
        const totalRevenue = filtered.reduce((sum, c) => sum + (c.revenue || 0), 0);

        // –ö–æ–Ω–≤–µ—Ä—Å–∏–∏ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≥–¥–µ revenue != 0
        const conversionsCount = filtered.filter(c => c.revenue !== 0).length;

        // –ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ offer_id, —É—Å–ª–æ–≤–∏–µ: —Å—É–º–º–∞ earnings >= 5000
        const offersByEarnings = {};
        filtered.forEach(c => {
            if (!offersByEarnings[c.offer_id]) {
                offersByEarnings[c.offer_id] = 0;
            }
            offersByEarnings[c.offer_id] += c.earnings || 0;
        });
        const activeOffers = Object.values(offersByEarnings).filter(e => e >= 5000).length;

        // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ partner_id, —É—Å–ª–æ–≤–∏–µ: —Å—É–º–º–∞ earnings >= 5000
        const partnersByEarnings = {};
        filtered.forEach(c => {
            if (!partnersByEarnings[c.partner_id]) {
                partnersByEarnings[c.partner_id] = 0;
            }
            partnersByEarnings[c.partner_id] += c.earnings || 0;
        });
        const activePartners = Object.values(partnersByEarnings).filter(e => e >= 5000).length;

        // ROMI = (–î–æ—Ö–æ–¥ / –û–†–ë) * 100
        const romi = totalRevenue > 0 ? (totalEarnings / totalRevenue) * 100 : 0;

        return {
            totalEarnings,
            totalRevenue,
            conversions: conversionsCount,
            activeOffers,
            activePartners,
            romi
        };
    }

    // ====== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ======
    function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        login(username, password);
    }

    function handleLoadData() {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        loadDashboardData(dateFrom, dateTo);
    }

    function handleLogout() {
        logout();
    }

    // ====== –†–ï–ù–î–ï–†–ò–ù–ì ======
    function render() {
        const root = document.getElementById('root');
        
        if (!state.isLoggedIn) {
            root.innerHTML = LoginPage();
        } else {
            root.innerHTML = DashboardPage();
        }
    }

    // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
    if (state.isLoggedIn) {
        state.currentPage = 'dashboard';
        loadDashboardData(state.dateFrom, state.dateTo);
    } else {
        render();
    }
    </script>
</body>
</html>
