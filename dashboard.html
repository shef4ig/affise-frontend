<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affise Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #667eea;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .metric-value.currency::before {
            content: '‚ÇΩ';
            font-size: 20px;
            margin-right: 4px;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filters h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .data-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .data-table h3 {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            font-size: 13px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f5;
            font-size: 13px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-paused {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Affise Analytics Dashboard</h1>
        <div class="user-info">
            <div>
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="username"></strong></span>
            </div>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="content" style="display: none;">
            
            <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (–û–ü)</div>
                    <div class="metric-value currency" id="metric-op">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–û–±—â–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç (–û–†–ë)</div>
                    <div class="metric-value currency" id="metric-orb">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏–∏</div>
                    <div class="metric-value" id="metric-conversions">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã</div>
                    <div class="metric-value" id="metric-offers">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</div>
                    <div class="metric-value" id="metric-partners">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ó–∞–∫–∞–∑—ã</div>
                    <div class="metric-value currency" id="metric-orders">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–î–æ—Ö–æ–¥</div>
                    <div class="metric-value currency" id="metric-income">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROMI</div>
                    <div class="metric-value" id="metric-romi">0%</div>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters">
                <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>–î–∞—Ç–∞ –æ—Ç</label>
                        <input type="date" id="filter-date-from">
                    </div>
                    <div class="filter-group">
                        <label>–î–∞—Ç–∞ –¥–æ</label>
                        <input type="date" id="filter-date-to">
                    </div>
                    <div class="filter-group">
                        <label>–û—Ñ—Ñ–µ—Ä</label>
                        <select id="filter-offer">
                            <option value="">–í—Å–µ –æ—Ñ—Ñ–µ—Ä—ã</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>–ü–∞—Ä—Ç–Ω—ë—Ä</label>
                        <input type="text" id="filter-partner" placeholder="ID –ø–∞—Ä—Ç–Ω—ë—Ä–∞">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
            <div class="data-table">
                <h3>–ö–æ–Ω–≤–µ—Ä—Å–∏–∏ (<span id="table-count">0</span> –∑–∞–ø–∏—Å–µ–π)</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û—Ñ—Ñ–µ—Ä</th>
                                <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–î–æ—Ö–æ–¥</th>
                                <th>–ü—Ä–∏–±—ã–ª—å</th>
                                <th>Goal</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ URL –≤–∞—à–µ–≥–æ API –Ω–∞ Railway
        const API_URL = 'https://affise-backend-production.up.railway.app';
        
        let allData = [];
        let currentFilters = {};

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                window.location.href = 'login.html';
                return false;
            }
            
            document.getElementById('username').textContent = username;
            return token;
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }
// –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
function getDefaultDateFrom() {
    const date = new Date();
    date.setDate(date.getDate() - 30);
    return date.toISOString().split('T')[0];
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
function getDefaultDateTo() {
    return new Date().toISOString().split('T')[0];
}
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            const token = checkAuth();
            if (!token) return;

            try {
               // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∏–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
const dateFrom = document.getElementById('dateFrom')?.value || getDefaultDateFrom();
const dateTo = document.getElementById('dateTo')?.value || getDefaultDateTo();

const response = await fetch(`${API_URL}/api/dashboard-data?date_from=${dateFrom}&date_to=${dateTo}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
                }

                const data = await response.json();
                allData = data;
                
                updateMetrics(data);
                updateFilters(data);
                updateTable(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        function updateMetrics(data) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ç—Ä–∏–∫
            const validGoals = [1, 2, 5, 10];
            const confirmedData = data.filter(d => 
                validGoals.includes(parseInt(d.goal_value)) && 
                d.status === 'confirmed'
            );
            
            // –û–ü (–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å)
            const op = confirmedData.reduce((sum, d) => sum + parseFloat(d.earnings || 0), 0);
            document.getElementById('metric-op').textContent = op.toFixed(2);
            
            // –û–†–ë (–û–±—â–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç)
            const orb = confirmedData.reduce((sum, d) => sum + parseFloat(d.revenue || 0), 0);
            document.getElementById('metric-orb').textContent = orb.toFixed(2);
            
            // –ö–æ–Ω–≤–µ—Ä—Å–∏–∏
            const conversions = confirmedData.filter(d => parseFloat(d.revenue || 0) !== 0).length;
            document.getElementById('metric-conversions').textContent = conversions;
            
            // –ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã (earnings >= 5000)
            const offerEarnings = {};
            confirmedData.forEach(d => {
                const offerId = d.offer_id;
                if (!offerEarnings[offerId]) offerEarnings[offerId] = 0;
                offerEarnings[offerId] += parseFloat(d.earnings || 0);
            });
            const activeOffers = Object.values(offerEarnings).filter(e => e >= 5000).length;
            document.getElementById('metric-offers').textContent = activeOffers;
            
            // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã (earnings >= 5000)
            const partnerEarnings = {};
            confirmedData.forEach(d => {
                const partnerId = d.partner_id;
                if (!partnerEarnings[partnerId]) partnerEarnings[partnerId] = 0;
                partnerEarnings[partnerId] += parseFloat(d.earnings || 0);
            });
            const activePartners = Object.values(partnerEarnings).filter(e => e >= 5000).length;
            document.getElementById('metric-partners').textContent = activePartners;
            
            // –ó–∞–∫–∞–∑—ã (goal_value = 4, –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ status)
            const orders = data
                .filter(d => parseInt(d.goal_value) === 4)
                .reduce((sum, d) => sum + parseFloat(d.sum || 0), 0);
            document.getElementById('metric-orders').textContent = orders.toFixed(2);
            
            // –î–æ—Ö–æ–¥ (goal_value –≤ [1,2,5,10], –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ status)
            const income = data
                .filter(d => validGoals.includes(parseInt(d.goal_value)))
                .reduce((sum, d) => sum + parseFloat(d.sum || 0), 0);
            document.getElementById('metric-income').textContent = income.toFixed(2);
            
            // ROMI
            const romi = orb > 0 ? ((income / orb) * 100) : 0;
            document.getElementById('metric-romi').textContent = romi.toFixed(2) + '%';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters(data) {
            const offerSelect = document.getElementById('filter-offer');
            const offers = [...new Set(data.map(d => d.offer_id))].sort((a, b) => a - b);
            
            offers.forEach(offerId => {
                const option = document.createElement('option');
                option.value = offerId;
                option.textContent = `–û—Ñ—Ñ–µ—Ä ${offerId}`;
                offerSelect.appendChild(option);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function updateTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            document.getElementById('table-count').textContent = data.length;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 100 –∑–∞–ø–∏—Å–µ–π
            const displayData = data.slice(0, 100);
            
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                
                const statusClass = 
                    row.status === 'confirmed' ? 'status-active' :
                    row.status === 'pending' ? 'status-paused' :
                    'status-inactive';
                
                tr.innerHTML = `
                    <td>${row.id || '-'}</td>
                    <td>${row.created_at ? new Date(row.created_at).toLocaleDateString('ru-RU') : '-'}</td>
                    <td>${row.offer_id || '-'}</td>
                    <td>${row.partner_id || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${row.status || '-'}</span></td>
                    <td>‚ÇΩ${parseFloat(row.sum || 0).toFixed(2)}</td>
                    <td>‚ÇΩ${parseFloat(row.revenue || 0).toFixed(2)}</td>
                    <td>‚ÇΩ${parseFloat(row.earnings || 0).toFixed(2)}</td>
                    <td>${row.goal_value || '-'}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const offerId = document.getElementById('filter-offer').value;
            const partnerId = document.getElementById('filter-partner').value;
            
            let filtered = [...allData];
            
            if (dateFrom) {
                filtered = filtered.filter(d => {
                    const date = new Date(d.created_at);
                    return date >= new Date(dateFrom);
                });
            }
            
            if (dateTo) {
                filtered = filtered.filter(d => {
                    const date = new Date(d.created_at);
                    return date <= new Date(dateTo);
                });
            }
            
            if (offerId) {
                filtered = filtered.filter(d => d.offer_id == offerId);
            }
            
            if (partnerId) {
                filtered = filtered.filter(d => d.partner_id == partnerId);
            }
            
            updateMetrics(filtered);
            updateTable(filtered);
        }

        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-offer').value = '';
            document.getElementById('filter-partner').value = '';
            
            updateMetrics(allData);
            updateTable(allData);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>

